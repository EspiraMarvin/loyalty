// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Outlet represents a physical location
model Outlet {
  id                     String                  @id
  name                   String
  description            String?
  isActive               Boolean
  merchantId             String
  Merchant               Merchant                @relation(fields: [merchantId], references: [id])
  PaybillOrTills         PaybillOrTill[]
  CashbackConfigurations CashbackConfiguration[] // Many-to-many
  ExclusiveOffers        ExclusiveOffer[] // Many-to-many
  Review                 Review?                 @relation(fields: [reviewId], references: [id])
  reviewId               String?                 @unique

  @@index([isActive, merchantId])
  @@index([merchantId, isActive])
  @@index([reviewId])
}

// Merchant represents a business
model Merchant {
  id                     String                  @id
  businessName           String
  description            String?
  status                 String // e.g., "Active", "Pending"
  category               String
  LoyaltyProgram         LoyaltyProgram? // One-to-one
  CashbackConfigurations CashbackConfiguration[]
  ExclusiveOffers        ExclusiveOffer[]
  Outlets                Outlet[]
  CustomerTypes          CustomerType[]

  @@index([status, category])
  @@index([status])
}

// Cashback Configuration
model CashbackConfiguration {
  id                    String                         @id
  name                  String
  startDate             DateTime?
  endDate               DateTime?
  isActive              Boolean                        @default(true)
  deletedAt             DateTime?
  EligibleCustomerTypes CashbackEligibleCustomerType[]
  merchantId            String
  Merchant              Merchant                       @relation(fields: [merchantId], references: [id])
  Outlets               Outlet[] // Many-to-many
  Review                Review?                        @relation(fields: [reviewId], references: [id])
  reviewId              String?                        @unique

  // Budget tracking
  netCashbackBudget          Decimal                     @default(0.0)
  usedCashbackBudget         Decimal                     @default(0.0)
  CashbackConfigurationTiers CashbackConfigurationTier[]

  @@index([merchantId, isActive])
  @@index([isActive, deletedAt])
}

// Exclusive Offer
model ExclusiveOffer {
  id                    String                               @id
  name                  String
  description           String
  startDate             DateTime
  endDate               DateTime
  isActive              Boolean                              @default(true)
  deletedAt             DateTime?
  EligibleCustomerTypes ExclusiveOfferEligibleCustomerType[]
  merchantId            String?
  Merchant              Merchant?                            @relation(fields: [merchantId], references: [id])
  Outlets               Outlet[] // Many-to-many
  Review                Review?                              @relation(fields: [reviewId], references: [id])
  reviewId              String?                              @unique

  // Budget tracking
  netOfferBudget  Decimal @default(0.0)
  usedOfferBudget Decimal @default(0.0)

  @@index([merchantId, isActive])
  @@index([isActive, deletedAt])
  @@index([startDate, endDate])
}

// Loyalty Program
model LoyaltyProgram {
  id                     String                  @id
  name                   String
  isActive               Boolean                 @default(true)
  merchantId             String?                 @unique
  Merchant               Merchant?               @relation(fields: [merchantId], references: [id])
  LoyaltyTiers           LoyaltyTier[]
  MerchantLoyaltyRewards MerchantLoyaltyReward[]
  Review                 Review?                 @relation(fields: [reviewId], references: [id])
  reviewId               String?                 @unique

  // Limits
  pointsUsedInPeriod Decimal  @default(0)
  pointsIssuedLimit  Decimal?

  @@index([isActive, merchantId])
  @@index([reviewId])
}

// Loyalty Tier
model LoyaltyTier {
  id               String         @id
  name             String
  isActive         Boolean        @default(true)
  deletedAt        DateTime?
  minCustomerType  String // e.g., "New", "Regular", "VIP" - for display
  minRank          Int // Numeric rank for hierarchy: 0=NonCustomer, 1=New, 2=Infrequent, 3=Occasional, 4=Regular, 5=VIP
  loyaltyProgramId String
  LoyaltyProgram   LoyaltyProgram @relation(fields: [loyaltyProgramId], references: [id])
  Review           Review?        @relation(fields: [reviewId], references: [id])
  reviewId         String?        @unique

  @@index([loyaltyProgramId, isActive, minRank])
  @@index([isActive, deletedAt])
  @@index([minRank, isActive])
}

// CustomerType tracks user's relationship with merchants
model CustomerType {
  id         String   @id
  userId     String
  merchantId String
  type       String // e.g., "New", "Regular", "VIP"
  rank       Int // Numeric rank: 0=NonCustomer, 1=New, 2=Infrequent, 3=Occasional, 4=Regular, 5=VIP
  Merchant   Merchant @relation(fields: [merchantId], references: [id])

  @@index([userId])
  @@index([merchantId, userId])
  @@index([userId, rank])
}

// Review model
model Review {
  id                        String                     @id
  status                    String // "Approved", "Pending", "Rejected"
  // back-relations
  Outlet                    Outlet?
  CashbackConfiguration     CashbackConfiguration?
  ExclusiveOffer            ExclusiveOffer?
  LoyaltyProgram            LoyaltyProgram?
  LoyaltyTier               LoyaltyTier?
  PaybillOrTill             PaybillOrTill?
  CashbackConfigurationTier CashbackConfigurationTier?
  MerchantLoyaltyReward     MerchantLoyaltyReward?

  @@index([status])
}

// PaybillOrTill represents payment methods for outlets
model PaybillOrTill {
  id        String    @id
  name      String
  isActive  Boolean   @default(true)
  deletedAt DateTime?
  outletId  String
  Outlet    Outlet    @relation(fields: [outletId], references: [id])
  Review    Review?   @relation(fields: [reviewId], references: [id])
  reviewId  String?   @unique

  @@index([outletId, isActive, deletedAt])
  @@index([isActive, deletedAt])
}

// CashbackConfigurationTier represents different cashback percentage tiers
model CashbackConfigurationTier {
  id                      String                @id
  name                    String
  percentage              Decimal
  isActive                Boolean               @default(true)
  deletedAt               DateTime?
  cashbackConfigurationId String
  CashbackConfiguration   CashbackConfiguration @relation(fields: [cashbackConfigurationId], references: [id])
  Review                  Review?               @relation(fields: [reviewId], references: [id])
  reviewId                String?               @unique

  @@index([cashbackConfigurationId, isActive, deletedAt])
  @@index([isActive, deletedAt, percentage])
}

// MerchantLoyaltyReward represents rewards in a loyalty program
model MerchantLoyaltyReward {
  id               String         @id
  name             String
  description      String?
  pointsCost       Decimal
  isActive         Boolean        @default(true)
  loyaltyProgramId String
  LoyaltyProgram   LoyaltyProgram @relation(fields: [loyaltyProgramId], references: [id])
  Review           Review?        @relation(fields: [reviewId], references: [id])
  reviewId         String?        @unique

  @@index([loyaltyProgramId, isActive])
  @@index([isActive])
}

// pivot table for CashbackConfiguration eligibility
model CashbackEligibleCustomerType {
  id                      String                @id @default(uuid())
  cashbackConfigurationId String
  customerType            String // "All", "NonCustomer", "New", "Infrequent", "Occasional", "Regular", "VIP"
  CashbackConfiguration   CashbackConfiguration @relation(fields: [cashbackConfigurationId], references: [id], onDelete: Cascade)

  @@unique([cashbackConfigurationId, customerType])
  @@index([customerType])
  @@index([cashbackConfigurationId, customerType])
}

// pivot table for ExclusiveOffer eligibility
model ExclusiveOfferEligibleCustomerType {
  id               String         @id @default(uuid())
  exclusiveOfferId String
  customerType     String // "All", "NonCustomer", "New", "Infrequent", "Occasional", "Regular", "VIP"
  ExclusiveOffer   ExclusiveOffer @relation(fields: [exclusiveOfferId], references: [id], onDelete: Cascade)

  @@unique([exclusiveOfferId, customerType])
  @@index([customerType])
  @@index([exclusiveOfferId, customerType])
}
